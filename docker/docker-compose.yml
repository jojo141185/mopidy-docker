version: '3.5'
services:
    mopidy:
        container_name: mopidy
        restart: always
        
        ## Run container as root
        # This is required to modify the PUID and PGID by entrypoint script
        user: root

        ## Run cointainer in privileged mode (can help with permission issues)
        # privileged: true

        ## Add container to audio group 
        # change group name or id to your system's audio group
        group_add:
            - audio
        
        ## Add audio device 
        # Change to your system's audio device
        devices:
            - /dev/snd

        volumes:
            # Mopidy config files
            - './config:/config'
            
            # Local media dir
            #- './media:/var/lib/mopidy/media:ro'
            
            # Store mopidy library and images on host (persistent)
            #- './local:/var/lib/mopidy/local'
            
            # Keep spotify credetnials (persistent)
            #- './.spotify:/var/lib/mopidy/spotify'
            
            ## Host Audio Support
            # --- ALSA ---
            # Mopidy Config: [audio] output=alsasink
            - /dev/snd:/dev/snd     # ALSA device (necessary)
            # Optional: If you have specific configurations or adjustments defined
            #- /etc/asound.conf:/etc/asound.conf
            #- /usr/share/alsa:/usr/share/alsa

            # --- PulseAudio ---
            # Mopidy Config: [audio] output=pulsesink
            # PulseAudio config (path should match with PUID)
            - $XDG_RUNTIME_DIR/pulse:/run/user/1000/pulse                # runtime directory
            - $XDG_RUNTIME_DIR/pulse/native:/run/user/1000/pulse/native  # socket
        ports:
            - '6600:6600'   # JSON-RPC API and MPD protocol
            - '6680:6680'   # HTTP WebUI
            
        image: 'jojo141185/mopidy:latest'   # ImageName:Version
        
        environment: 
            # Set mopidy user and audio group id to match host's specific permissions
            - PUID=1000
            - PGID=29

            # PulseAudio server socket for communication (path should match with PUID)
            - PULSE_SERVER=unix:/run/user/1000/pulse/native
            #- PULSE_COOKIE_DATA=<YOUR_PULSE_COOKIE_DATA>  # (optional)
            
            # Install additional pip packages
            #- PIP_PACKAGES=Mopidy-TuneIn Mopidy-Youtube yt-dlp
